{
    "AWSTemplateFormatVersion": "2010-09-09",
	"Resources": {
		"IdentityProvider": {
		  "Type": "Custom::IdentityProvider",
		  "Properties": {
			"ServiceToken": { "Fn::GetAtt" : ["IdPLambda", "Arn"] },
			"Region": { "Ref" : "AWS::Region" },
			"Metadata": "<?xml version=\"1.0\" encoding=\"utf-8\"?><EntityDescriptor ID=\"_0b0efd06-cef0-4a6d-a77e-33885e4830be\" entityID=\"https://sts.windows.net/52497ec2-0945-4f55-8021-79766363dd96/\" xmlns=\"urn:oasis:names:tc:SAML:2.0:metadata\"><Signature xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><SignedInfo><CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /><SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\" /><Reference URI=\"#_0b0efd06-cef0-4a6d-a77e-33885e4830be\"><Transforms><Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\" /><Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\" /></Transforms><DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\" /><DigestValue>bVrk4EmH48bzTkPo7bFECvicA6MMhCl4qMxALbtbW3E=</DigestValue></Reference></SignedInfo><SignatureValue>T6MU3p0G1a1QEK/AgThohV6wEPq2ITYcrw5j2h/Cu5XeriAvoT6GfwYfWiMDL0Z87aOIF6mGpPuP/awQpNnJo3bz8m406u79nQTiYFgSC5DtWRmBdd41QrL1IPydwAWi/EPgMIuvLd/4uAA+njuyvibsnf5twZRTCtgvMwF73k7TkETTDDurYNfnueRtjB3BMDpTJWY3d7CBUf0tkNJGgUw1ysrK9m2d9v5Fz/71awk+aUvFUms9pYsclzRhOLRzfie0LfWRDPikXl6BW+xiyemiknFBSHTKPJexnZ+RKsWpZNERdYJm1zVbOaIwjYsDmghZY9PNGYxLLlPXTdejyw==</SignatureValue><KeyInfo><X509Data><X509Certificate>MIIC8DCCAdigAwIBAgIQYsAoQu8H+qpG4jcgwT3a8DANBgkqhkiG9w0BAQsFADA0MTIwMAYDVQQDEylNaWNyb3NvZnQgQXp1cmUgRmVkZXJhdGVkIFNTTyBDZXJ0aWZpY2F0ZTAeFw0xOTEwMjIwOTQwMDVaFw0yMjEwMjIwOTQwMDVaMDQxMjAwBgNVBAMTKU1pY3Jvc29mdCBBenVyZSBGZWRlcmF0ZWQgU1NPIENlcnRpZmljYXRlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3aKHOoo7UMlkD7OFdbV7uQc0Po14Lw/kr6In/QBV6Ajmx5ZqwA0JGGnc2e9PL1605T0aPLAplFX+onq0jRDvRpPU2vGxhw6It7dMIqacg+9mjWPHlWhR+JGTd9EuXE2lc+h/1bklSeveEPLGJUTzlrhwrphOmh+OJnE23JAashYsoggsJnNNLgpjzwbX95/kQGj8Tyev8CiaUuka7zAa34KPJwucCJ7WA8A8cz6h7+vK/OR4QOhvTI61RA1ySziZqxlO3h+I0WDDb8VAKHEY/9mWG42haIm0trzt1vrmi7rJmYM5Hp1SQDNEt5YAmCIxAdEr86fshz8VciqorFLe2wIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBsTT3QVwvUsQMt9Yxl6fCgB6L4+qFc5mjjsAtGwd0h8WDCqGfoylVqCwu9V2baGM9SJLNLOupqZ1NfYPXQY5S9qgXd9oXHV0weY9h3HvFQ1q/gWDdbVo7lDvgx/+mFOBtRAvMJDO/0AFzxkHfnnDl1gf9gouNEf96BtKA39z+Wo2+74liRfveDZ1AqdPp3/lZcUMbxKUwioXysIN8a22ALy/UrpjTFpC1xvAbA94A45O27+Vm/XbjA0djxsuT2lRrHL1qi9mX0qe9sSyslMNoeElsIv6DYmbkgJvn7FEGlFxz4FolU3gObl5SbpD46zUSqXkQWaKgMs64JAAMzDvu+</X509Certificate></X509Data></KeyInfo></Signature><RoleDescriptor xsi:type=\"fed:SecurityTokenServiceType\" protocolSupportEnumeration=\"http://docs.oasis-open.org/wsfed/federation/200706\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:fed=\"http://docs.oasis-open.org/wsfed/federation/200706\"><KeyDescriptor use=\"signing\"><KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><X509Data><X509Certificate>MIIC8DCCAdigAwIBAgIQYsAoQu8H+qpG4jcgwT3a8DANBgkqhkiG9w0BAQsFADA0MTIwMAYDVQQDEylNaWNyb3NvZnQgQXp1cmUgRmVkZXJhdGVkIFNTTyBDZXJ0aWZpY2F0ZTAeFw0xOTEwMjIwOTQwMDVaFw0yMjEwMjIwOTQwMDVaMDQxMjAwBgNVBAMTKU1pY3Jvc29mdCBBenVyZSBGZWRlcmF0ZWQgU1NPIENlcnRpZmljYXRlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3aKHOoo7UMlkD7OFdbV7uQc0Po14Lw/kr6In/QBV6Ajmx5ZqwA0JGGnc2e9PL1605T0aPLAplFX+onq0jRDvRpPU2vGxhw6It7dMIqacg+9mjWPHlWhR+JGTd9EuXE2lc+h/1bklSeveEPLGJUTzlrhwrphOmh+OJnE23JAashYsoggsJnNNLgpjzwbX95/kQGj8Tyev8CiaUuka7zAa34KPJwucCJ7WA8A8cz6h7+vK/OR4QOhvTI61RA1ySziZqxlO3h+I0WDDb8VAKHEY/9mWG42haIm0trzt1vrmi7rJmYM5Hp1SQDNEt5YAmCIxAdEr86fshz8VciqorFLe2wIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBsTT3QVwvUsQMt9Yxl6fCgB6L4+qFc5mjjsAtGwd0h8WDCqGfoylVqCwu9V2baGM9SJLNLOupqZ1NfYPXQY5S9qgXd9oXHV0weY9h3HvFQ1q/gWDdbVo7lDvgx/+mFOBtRAvMJDO/0AFzxkHfnnDl1gf9gouNEf96BtKA39z+Wo2+74liRfveDZ1AqdPp3/lZcUMbxKUwioXysIN8a22ALy/UrpjTFpC1xvAbA94A45O27+Vm/XbjA0djxsuT2lRrHL1qi9mX0qe9sSyslMNoeElsIv6DYmbkgJvn7FEGlFxz4FolU3gObl5SbpD46zUSqXkQWaKgMs64JAAMzDvu+</X509Certificate></X509Data></KeyInfo></KeyDescriptor><fed:ClaimTypesOffered><auth:ClaimType Uri=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Name</auth:DisplayName><auth:Description>The mutable display name of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Subject</auth:DisplayName><auth:Description>An immutable, globally unique, non-reusable identifier of the user that is unique to the application for which a token is issued.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Given Name</auth:DisplayName><auth:Description>First name of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Surname</auth:DisplayName><auth:Description>Last name of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/displayname\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Display Name</auth:DisplayName><auth:Description>Display name of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/nickname\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Nick Name</auth:DisplayName><auth:Description>Nick name of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationinstant\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Authentication Instant</auth:DisplayName><auth:Description>The time (UTC) when the user is authenticated to Windows Azure Active Directory.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/authenticationmethod\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Authentication Method</auth:DisplayName><auth:Description>The method that Windows Azure Active Directory uses to authenticate users.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/objectidentifier\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>ObjectIdentifier</auth:DisplayName><auth:Description>Primary identifier for the user in the directory. Immutable, globally unique, non-reusable.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/tenantid\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>TenantId</auth:DisplayName><auth:Description>Identifier for the user's tenant.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/identityprovider\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>IdentityProvider</auth:DisplayName><auth:Description>Identity provider for the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Email</auth:DisplayName><auth:Description>Email address of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/groups\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Groups</auth:DisplayName><auth:Description>Groups of the user.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/accesstoken\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>External Access Token</auth:DisplayName><auth:Description>Access token issued by external identity provider.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/expiration\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>External Access Token Expiration</auth:DisplayName><auth:Description>UTC expiration time of access token issued by external identity provider.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/identity/claims/openid2_id\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>External OpenID 2.0 Identifier</auth:DisplayName><auth:Description>OpenID 2.0 identifier issued by external identity provider.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/claims/groups.link\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>GroupsOverageClaim</auth:DisplayName><auth:Description>Issued when number of user's group claims exceeds return limit.</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/role\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>Role Claim</auth:DisplayName><auth:Description>Roles that the user or Service Principal is attached to</auth:Description></auth:ClaimType><auth:ClaimType Uri=\"http://schemas.microsoft.com/ws/2008/06/identity/claims/wids\" xmlns:auth=\"http://docs.oasis-open.org/wsfed/authorization/200706\"><auth:DisplayName>RoleTemplate Id Claim</auth:DisplayName><auth:Description>Role template id of the Built-in Directory Roles that the user is a member of</auth:Description></auth:ClaimType></fed:ClaimTypesOffered><fed:SecurityTokenServiceEndpoint><wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/wsfed</wsa:Address></wsa:EndpointReference></fed:SecurityTokenServiceEndpoint><fed:PassiveRequestorEndpoint><wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/wsfed</wsa:Address></wsa:EndpointReference></fed:PassiveRequestorEndpoint></RoleDescriptor><RoleDescriptor xsi:type=\"fed:ApplicationServiceType\" protocolSupportEnumeration=\"http://docs.oasis-open.org/wsfed/federation/200706\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:fed=\"http://docs.oasis-open.org/wsfed/federation/200706\"><KeyDescriptor use=\"signing\"><KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><X509Data><X509Certificate>MIIC8DCCAdigAwIBAgIQYsAoQu8H+qpG4jcgwT3a8DANBgkqhkiG9w0BAQsFADA0MTIwMAYDVQQDEylNaWNyb3NvZnQgQXp1cmUgRmVkZXJhdGVkIFNTTyBDZXJ0aWZpY2F0ZTAeFw0xOTEwMjIwOTQwMDVaFw0yMjEwMjIwOTQwMDVaMDQxMjAwBgNVBAMTKU1pY3Jvc29mdCBBenVyZSBGZWRlcmF0ZWQgU1NPIENlcnRpZmljYXRlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3aKHOoo7UMlkD7OFdbV7uQc0Po14Lw/kr6In/QBV6Ajmx5ZqwA0JGGnc2e9PL1605T0aPLAplFX+onq0jRDvRpPU2vGxhw6It7dMIqacg+9mjWPHlWhR+JGTd9EuXE2lc+h/1bklSeveEPLGJUTzlrhwrphOmh+OJnE23JAashYsoggsJnNNLgpjzwbX95/kQGj8Tyev8CiaUuka7zAa34KPJwucCJ7WA8A8cz6h7+vK/OR4QOhvTI61RA1ySziZqxlO3h+I0WDDb8VAKHEY/9mWG42haIm0trzt1vrmi7rJmYM5Hp1SQDNEt5YAmCIxAdEr86fshz8VciqorFLe2wIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBsTT3QVwvUsQMt9Yxl6fCgB6L4+qFc5mjjsAtGwd0h8WDCqGfoylVqCwu9V2baGM9SJLNLOupqZ1NfYPXQY5S9qgXd9oXHV0weY9h3HvFQ1q/gWDdbVo7lDvgx/+mFOBtRAvMJDO/0AFzxkHfnnDl1gf9gouNEf96BtKA39z+Wo2+74liRfveDZ1AqdPp3/lZcUMbxKUwioXysIN8a22ALy/UrpjTFpC1xvAbA94A45O27+Vm/XbjA0djxsuT2lRrHL1qi9mX0qe9sSyslMNoeElsIv6DYmbkgJvn7FEGlFxz4FolU3gObl5SbpD46zUSqXkQWaKgMs64JAAMzDvu+</X509Certificate></X509Data></KeyInfo></KeyDescriptor><fed:TargetScopes><wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://sts.windows.net/52497ec2-0945-4f55-8021-79766363dd96/</wsa:Address></wsa:EndpointReference></fed:TargetScopes><fed:ApplicationServiceEndpoint><wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/wsfed</wsa:Address></wsa:EndpointReference></fed:ApplicationServiceEndpoint><fed:PassiveRequestorEndpoint><wsa:EndpointReference xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/wsfed</wsa:Address></wsa:EndpointReference></fed:PassiveRequestorEndpoint></RoleDescriptor><IDPSSODescriptor protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><KeyDescriptor use=\"signing\"><KeyInfo xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><X509Data><X509Certificate>MIIC8DCCAdigAwIBAgIQYsAoQu8H+qpG4jcgwT3a8DANBgkqhkiG9w0BAQsFADA0MTIwMAYDVQQDEylNaWNyb3NvZnQgQXp1cmUgRmVkZXJhdGVkIFNTTyBDZXJ0aWZpY2F0ZTAeFw0xOTEwMjIwOTQwMDVaFw0yMjEwMjIwOTQwMDVaMDQxMjAwBgNVBAMTKU1pY3Jvc29mdCBBenVyZSBGZWRlcmF0ZWQgU1NPIENlcnRpZmljYXRlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3aKHOoo7UMlkD7OFdbV7uQc0Po14Lw/kr6In/QBV6Ajmx5ZqwA0JGGnc2e9PL1605T0aPLAplFX+onq0jRDvRpPU2vGxhw6It7dMIqacg+9mjWPHlWhR+JGTd9EuXE2lc+h/1bklSeveEPLGJUTzlrhwrphOmh+OJnE23JAashYsoggsJnNNLgpjzwbX95/kQGj8Tyev8CiaUuka7zAa34KPJwucCJ7WA8A8cz6h7+vK/OR4QOhvTI61RA1ySziZqxlO3h+I0WDDb8VAKHEY/9mWG42haIm0trzt1vrmi7rJmYM5Hp1SQDNEt5YAmCIxAdEr86fshz8VciqorFLe2wIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBsTT3QVwvUsQMt9Yxl6fCgB6L4+qFc5mjjsAtGwd0h8WDCqGfoylVqCwu9V2baGM9SJLNLOupqZ1NfYPXQY5S9qgXd9oXHV0weY9h3HvFQ1q/gWDdbVo7lDvgx/+mFOBtRAvMJDO/0AFzxkHfnnDl1gf9gouNEf96BtKA39z+Wo2+74liRfveDZ1AqdPp3/lZcUMbxKUwioXysIN8a22ALy/UrpjTFpC1xvAbA94A45O27+Vm/XbjA0djxsuT2lRrHL1qi9mX0qe9sSyslMNoeElsIv6DYmbkgJvn7FEGlFxz4FolU3gObl5SbpD46zUSqXkQWaKgMs64JAAMzDvu+</X509Certificate></X509Data></KeyInfo></KeyDescriptor><SingleLogoutService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/saml2\" /><SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\" Location=\"https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/saml2\" /><SingleSignOnService Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" Location=\"https://login.microsoftonline.com/52497ec2-0945-4f55-8021-79766363dd96/saml2\" /></IDPSSODescriptor></EntityDescriptor>",
			"Name": "AzureAD"
		  }
		},
		"IdPLambda": {
		  "Type": "AWS::Lambda::Function",
		  "Properties": {
			"Runtime": "python2.7",
			"Handler": "index.lambda_handler",
			"MemorySize": 128,
			"Role": { "Fn::GetAtt" : ["IdPLambdaExecutionRole", "Arn"] },
			"Timeout": 30,
			"Code": {
			  "ZipFile": { "Fn::Join": ["", [
					"import boto3 \n",
					"from botocore.exceptions import ClientError \n",
					"import json \n",
					"import cfnresponse \n",
					"iam = boto3.client(\"iam\") \n",
					"def create_idp(name, saml_metadata): \n",
					"  try: \n",
					"    resp = iam.create_saml_provider(SAMLMetadataDocument=saml_metadata,Name=name) \n",
					"    return(True, resp['SAMLProviderArn']) \n",
					"  except Exception as e: \n",
					"    return (False, \"Could not create SAML IdP: \" + str(e)) \n",
					"def delete_idp(arn): \n",
					"  try: \n",
					"    iam.delete_saml_provider(SAMLProviderArn=arn) \n",
					"    return (True, \"SAML provider with ARN \" + arn + \" deleted\") \n",
					"  except ClientError as e: \n",
					"    if e.response['Error']['Code'] == \"NoSuchEntity\": \n",
					"      return (True, \"SAML provider with ARN \" + arn + \" already deleted.\") \n",
					"    else: \n",
					"      return (False, \"Could not delete SAML IdP with ARN \" + arn + \": \" + str(e)) \n",
					"  except Exception as e: \n",
					"    return (False, \"Could not delete SAML IdP with ARN \" + arn + \": \" + str(e)) \n",
					"def update_idp(arn, saml_metadata): \n",
					"  try: \n",
					"    resp = iam.update_saml_provider(SAMLMetadataDocument=saml_metadata, SAMLProviderArn=arn) \n",
					"    return (True, \"SAML provider \" + arn + \" updated\") \n",
					"  except Exception as e: \n",
					"    return (False, \"Cannot update SAML provider \" + arn + \": \" + str(e)) \n",
					"def lambda_handler(event, context): \n",
					"  saml_metadata = event['ResourceProperties']['Metadata'] \n",
					"  idp_name = event['ResourceProperties']['Name'] \n",
					"  if event['RequestType'] == 'Create': \n",
					"    res, idp_arn = create_idp(idp_name, saml_metadata) \n",
					"    reason = \"Creation succeeded\" \n",
					"  else: \n",
					"    idp_arn = \"arn:aws:iam::", { "Ref" : "AWS::AccountId" }, ":saml-provider/\" + idp_name \n",
					"    if event['RequestType'] == 'Update': \n",
					"      res, reason = update_idp(idp_arn, saml_metadata) \n",
					"    elif event['RequestType'] == 'Delete': \n",
					"      res, reason = delete_idp(idp_arn) \n",
					"    else: \n",
					"      res = False \n",
					"      reason = \"Unknown operation: \" + event['RequestType'] \n",
					"  responseData = {} \n",
					"  responseData['Reason'] = reason \n",
					"  if res: \n",
					"    cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, idp_arn) \n",
					"  else: \n",
					"    cfnresponse.send(event, context, cfnresponse.FAILED, responseData, idp_arn)\n"
				]]}
			}
		  }
		},
		"IdPLambdaExecutionRole": {
		  "Type": "AWS::IAM::Role",
		  "Properties": {
			"Path": "/",
			"AssumeRolePolicyDocument": {
			  "Version": "2012-10-17",
			  "Statement": [
				{
				  "Effect": "Allow",
				  "Principal": {
					"Service": [
					  "lambda.amazonaws.com"
					]
				  },
				  "Action": [
					"sts:AssumeRole"
				  ]
				}
			  ]
			},
			"Policies": [
			  {
				"PolicyName": "root",
				"PolicyDocument": {
				  "Version": "2012-10-17",
				  "Statement": [
					{
					  "Effect": "Allow",
					  "Action": [
						"iam:DeleteSamlProvider",
						"iam:GetSAMLProvider",
						"iam:UpdateSAMLProvider",
						"iam:CreateSAMLProvider"
					  ],
					  "Resource": "*"
					},
					{
					  "Effect": "Allow",
					  "Action": [
						"logs:CreateLogGroup",
						"logs:CreateLogStream",
						"logs:PutLogEvents"
					  ],
					  "Resource": "arn:aws:logs:*:*:*"
					}
				  ]
				}
			  }
			]
		  }
		},
		"FederatedPowerUserRole": {
			"Type": "AWS::IAM::Role",
			"DependsOn": [ "IdentityProvider" ],
			"Properties": {
				"RoleName": "FederatedPowerUserRole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": {
						"Effect": "Allow",
						"Action": "sts:AssumeRoleWithSAML",
						"Principal": {"Federated": { "Fn::Join" : ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" }, ":saml-provider/AzureAD" ]]}},
						"Condition": {"StringEquals": {"SAML:aud": "https://signin.aws.amazon.com/saml"}}
					}
				},
				"ManagedPolicyArns": [ "arn:aws:iam::aws:policy/PowerUserAccess" ],
				"Path": "/"
			}
		},
		"FederatedObserverRole": {
			"Type": "AWS::IAM::Role",
			"DependsOn": [ "IdentityProvider" ],
			"Properties": {
				"RoleName": "FederatedObserverRole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": {
						"Effect": "Allow",
						"Action": "sts:AssumeRoleWithSAML",
						"Principal": {"Federated": { "Fn::Join" : ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" }, ":saml-provider/AzureAD" ]]}},
						"Condition": {"StringEquals": {"SAML:aud": "https://signin.aws.amazon.com/saml"}}
					}
				},
				"ManagedPolicyArns": [ "arn:aws:iam::aws:policy/job-function/ViewOnlyAccess" ],
				"Path": "/"
			}
		},
		"FederatedDBARole": {
			"Type": "AWS::IAM::Role",
			"DependsOn": [ "IdentityProvider" ],
			"Properties": {
				"RoleName": "FederatedDBARole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": {
						"Effect": "Allow",
						"Action": "sts:AssumeRoleWithSAML",
						"Principal": {"Federated": { "Fn::Join" : ["", ["arn:aws:iam::", { "Ref" : "AWS::AccountId" }, ":saml-provider/AzureAD" ]]}},
						"Condition": {"StringEquals": {"SAML:aud": "https://signin.aws.amazon.com/saml"}}
					}
				},
				"ManagedPolicyArns": [ "arn:aws:iam::aws:policy/job-function/DatabaseAdministrator" ],
				"Path": "/"
			}
		}
   }
}
